<!DOCTYPE html>
<html lang="en">
<script type="text/javascript">
    const ipc = require('electron').ipcRenderer;
    const BrowserWindow = require('electron').remote.BrowserWindow;
    const fs = require('fs-extra');
    const path = require('path');
    const app = require('electron').remote.app
    const WinDrive = require('win-explorer');
    console.log()
    const db = require(path.join(path.dirname(__dirname), './models'));
    const { NormalizeName } = require(path.join(path.dirname(__dirname), './utils/StringUtil'));

    fileFilter = ['mp3', 'ogg', 'm4a'];

    var count = 0;
    var appPath = path.join(path.dirname(__dirname));
    var startTime, endTime;
    var currentDir = localStorage.getItem('currentDir');

    Storage.prototype.getObject = function (key) {
        var value = this.getItem(key);
        if (value == "undefined") return [];
        return value && JSON.parse(value);
    }

    ipc.on('remove-files', function (event, data, fromWindowId) {
        let fromWindow = BrowserWindow.fromId(fromWindowId)
        fs.removeSync(data.dir);
        fromWindow.webContents.send('files-removed', data.index);
        fromWindow.webContents.send('finish-proc');
        window.close();
    });

    var timer = 0;
    ipc.on('scan-dirs', function (event, data, fromWindowId) {
        let fromWindow = BrowserWindow.fromId(fromWindowId);
        var tempFiles = [];
        
        let total = 0;
        scanOneDir = async (dir) => {
            var fis = WinDrive.ListFilesRO(dir);
            await PopulateDB(dir, fis);
            console.log(tempFiles.length)
            if (tempFiles.length > 0) {
                try {
                    await db.audiofile.bulkCreate(tempFiles);
                } catch (err) {
                    console.log(err)
                    fromWindow.webContents.send('error', err);
                }
            }
            console.log(total)
            tempFiles = [];
        }

        scanDirs = async () => {
            timer = new Date();
            let dirs = localStorage.getObject('directories');
            if (dirs) {
                for (var f of dirs) {
                    await scanOneDir(f.path);
                }
            }
            fromWindow.webContents.send('error', "Scan Done: " + (new Date() - timer));
            window.close();
        }
        PopulateDB = async (folder, files, id) => {
            var fis = files.filter((f) => {
                return f.isDirectory || fileFilter.includes(f.extension.toLocaleLowerCase()) &&
                    !f.isHidden
            });
            
            if(fis.length === 0) return;

            var f1 = await db.directory.findOrCreate({
                where: {
                    Path: folder
                }
            });

            if (!f1[0].DirectoryId) {
                f1[0].update({
                    DirectoryId: id
                });
            }
            for (var f of fis) {
                var file = undefined;
                try {
                    if (!f.isDirectory) {
                        total++;
                        let found = tempFiles.find(v => v.Name === f.FileName);
                        file = await db.audiofile.findOne({
                            where: {
                                Name: f.FileName
                            }
                        });
                        
                        if (!file && !found) {
                            tempFiles.push({
                                Name: f.FileName,
                                NameNormalize: NormalizeName(f.FileName),
                                DirectoryId: f1[0].Id
                            });
                        }else{
                           if(found) fromWindow.webContents.send('error', "Duplicate: "+ found.Name);
                        }
                    } else {
                        await PopulateDB(f.FileName, f.Files, f1[0].Id);
                    }
                } catch (error) {
                    console.log(error);
                    fromWindow.webContents.send('error', f1[0].Name);
                    fromWindow.webContents.send('error', error);
                }
            }
        }

        scanDirs();
    });

</script>

</html>