<!DOCTYPE html>
<html lang="en">
<script type="text/javascript">
    const ipc = require('electron').ipcRenderer;
    const BrowserWindow = require('electron').remote.BrowserWindow;
    const fs = require('fs-extra');
    const path = require('path');
    const app = require('electron').remote.app
    const WinDrive = require('win-explorer');
    const db = require(path.join(path.dirname(__dirname), './models'));
    const { NormalizeName } = require(path.join(path.dirname(__dirname), './utils/StringUtil'));

    fileFilter = ['mp3', 'ogg', 'm4a'];

    var count = 0;
    var appPath = path.join(path.dirname(__dirname));
    var startTime, endTime;
    var currentDir = localStorage.getItem('currentDir');

    Storage.prototype.getObject = function (key) {
        var value = this.getItem(key);
        if (value == "undefined") return [];
        return value && JSON.parse(value);
    }

    ipc.on('remove-dup', function (event, dir, fromWindowId) {
        let fromWindow = BrowserWindow.fromId(fromWindowId)

        var tempFiles = [];
        fileFilter.push('wma');

        const removeDuplicate = async (folder, fis) => {
            var fis = fis.filter((f) => {
                return f.isDirectory || fileFilter.includes(f.extension.toLocaleLowerCase()) && !f.isHidden
            });

            for (var f of fis) {
                if (f.isDirectory) {
                    await removeDuplicate(f.FileName, f.Files);
                } else {
                    let found = tempFiles.find(a => a === f.FileName);
                    if (found) {
                        fromWindow.webContents.send('error', "Dup: " + f.FileName);
                        fs.removeSync(path.join(folder, f.FileName));
                    } else {
                        tempFiles.push(f.FileName);
                    }
                }
            }
        }
        let files = WinDrive.ListFilesRO(dir);
        fromWindow.webContents.send('error', files);
        removeDuplicate(dir, files).then(() => {
            window.close();
        });
    });

    var timer = 0;
    ipc.on('scan-dirs', function (event, data, fromWindowId) {
        let fromWindow = BrowserWindow.fromId(fromWindowId);
        var tempFiles = [];

        let total = 0;
        scanOneDir = async (dir) => {
            var fis = WinDrive.ListFilesRO(dir);
            await PopulateDB(dir, fis);
        }

        scanDirs = async () => {
            timer = new Date();
            let dirs = localStorage.getObject('directories');
            if (dirs) {
                for (var f of dirs) {
                    await scanOneDir(f.path);
                }
            }
            fromWindow.webContents.send('error', "Scan Done: " + (new Date() - timer));
            fromWindow.webContents.send('reload', true);
            window.close();
        }

        PopulateDB = async (folder, files, id) => {
            let fis = files.filter((f) => {
                return f.isDirectory || fileFilter.includes(f.extension.toLocaleLowerCase()) &&
                    !f.isHidden
            });

            if (fis.length === 0) return;
            let f1 = [{ Id: null }];
            if (fis.filter((f) => !f.isDirectory && fileFilter.includes(f.extension.toLocaleLowerCase())).length > 0) {
                
                f1 = await db.directory.findOrCreate({
                    where: {
                        Path: folder,
                        Name: path.basename(folder)
                    }
                });
            }

            var createfiles = [];

            for (let f of fis) {
                let file;
                try {
                    if (!f.isDirectory) {
                        total++;
                        let found = tempFiles.find(v => v.Name === f.FileName);
                        file = await db.file.findOne({
                            where: {
                                Name: f.FileName
                            }
                        });

                        if (!file && !found) {
                            let newFile = {
                                Name: f.FileName,
                                NameNormalize: NormalizeName(f.FileName),
                                DirectoryId: f1[0].Id
                            }
                            tempFiles.push(newFile);
                            createfiles.push(newFile);
                        } else {
                            if (found) fromWindow.webContents.send('error', "Duplicate: " + found.Name);
                        }
                    } else {
                        await PopulateDB(f.FileName, f.Files, f1[0].Id);
                    }
                } catch (error) {
                    fromWindow.webContents.send('error', f1[0].Name);
                    fromWindow.webContents.send('error', error);
                    // console.log(error)
                }
            }
            if (createfiles.length > 0) await db.file.bulkCreate(createfiles);
            createfiles = [];
        }

        scanDirs();
    });

</script>

</html>